apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: {{ res.name }}
  namespace: {{ data.namespace_name }}
  labels:
    app.kubernetes.io/managed-by: custom-tool
    env: {{ env }}
spec:
  entryPoints:
{% for ep in res.entrypoints %}
    - {{ ep }}
{% endfor %}
  routes:
{% for route in res.routes %}
    - kind: Rule
      match: {{ route.match | replace("{{ host }}", host) }}
      priority: {{ route.priority }}
{% if route.middlewares %}
      middlewares:
{% for mw in route.middlewares %}
        - name: {{ mw }}
{% endfor %}
{% endif %}
      services:
        - name: {{ route.service_name }}
          port: {{ route.service_port }}
{% endfor %}
